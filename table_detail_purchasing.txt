create table detail_purchsing (
	id serial primary key,
	purchasing_id int not null,
	supplier_id int not null,
	item_id int not null, 
	qty int not null,
	unit_price numeric not null,
	subtotal NUMERIC(12,2) GENERATED ALWAYS AS (qty * unit_price) STORED,
	created_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	updated_at timestamp DEFAULT CURRENT_TIMESTAMP NULL,
	foreign key (purchasing_id) references purchases (id),
	foreign key (item_id) references items (id)
);

CREATE OR REPLACE FUNCTION set_unit_price_from_item()
RETURNS TRIGGER AS $$
BEGIN
    -- Ambil harga sewa dari tabel dresses berdasarkan dress_id
    SELECT price INTO NEW.unit_price
    FROM items
    WHERE id = NEW.item_id;

    -- Hitung subtotal otomatis
    NEW.subtotal := NEW.qty * NEW.unit_price;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_set_unit_price
BEFORE INSERT OR UPDATE ON detail_purchsing
FOR EACH ROW
EXECUTE FUNCTION set_unit_price_from_item();